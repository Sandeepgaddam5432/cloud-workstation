name: â˜ï¸ Cloud Workstation - macOS (SSH + ngrok)

on:
  workflow_dispatch:

env:
  WORKSPACE_DIR: '$HOME/Desktop/workspace'
  BACKUP_REPO: 'backup-files'

jobs:
  macos-workstation:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: ğŸ“Š System Information
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         macOS Cloud Workstation Setup                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ–¥ï¸  macOS Version: $(sw_vers -productVersion)"
          echo "ğŸ’» Chip: $(uname -m)"
          echo "ğŸ“‚ User: $(whoami)"
          echo ""

      - name: ğŸ” Setup SSH Access via ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          echo "ğŸ”§ Setting up SSH access..."
          
          # Install ngrok
          brew install ngrok/ngrok/ngrok
          
          # Configure ngrok if token is provided
          if [ -n "$NGROK_AUTH_TOKEN" ]; then
            ngrok config add-authtoken "$NGROK_AUTH_TOKEN"
            echo "âœ… ngrok authenticated"
          else
            echo "âš ï¸ No NGROK_AUTH_TOKEN secret - using free tier (limited)"
          fi
          
          # Create SSH user password
          SSH_PASS="${{ secrets.SSH_PASSWORD }}"
          [ -z "$SSH_PASS" ] && SSH_PASS="P@ssw0rd123!"
          
          # Enable SSH and set password
          echo "ğŸ”‘ Configuring SSH..."
          
          # Set runner password for SSH login
          echo "runner:$SSH_PASS" | sudo chpasswd 2>/dev/null || {
            # Alternative method for macOS
            sudo dscl . -passwd /Users/runner "$SSH_PASS" 2>/dev/null || true
          }
          
          # Enable SSH
          sudo systemsetup -setremotelogin on 2>/dev/null || {
            sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || true
          }
          
          echo "âœ… SSH enabled"
          
          # Start ngrok SSH tunnel in background
          ngrok tcp 22 --log=stdout > /tmp/ngrok.log 2>&1 &
          
          echo "â³ Waiting for ngrok tunnel..."
          sleep 10
          
          # Extract ngrok URL
          for i in {1..30}; do
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | grep -oE 'tcp://[0-9a-z.-]+:[0-9]+' | head -1)
            if [ -n "$NGROK_URL" ]; then
              echo "$NGROK_URL" > /tmp/ngrok_url.txt
              echo "âœ… ngrok tunnel: $NGROK_URL"
              break
            fi
            sleep 2
          done
          
          if [ -z "$NGROK_URL" ]; then
            echo "âš ï¸ ngrok may still be initializing..."
            cat /tmp/ngrok.log | tail -20
          fi

      - name: ğŸ Install Python
        run: |
          echo "ğŸ Installing Python..."
          brew install python@3.11
          python3 --version
          pip3 --version
          echo "âœ… Python installed"

      - name: ğŸ“¦ Install Node.js
        run: |
          echo "ğŸ“¦ Installing Node.js..."
          brew install node
          node --version
          npm --version
          echo "âœ… Node.js installed"

      - name: ğŸ’» Install Visual Studio Code
        run: |
          echo "ğŸ’» Installing VS Code..."
          brew install --cask visual-studio-code
          echo "âœ… VS Code installed"

      - name: âš™ï¸ Configure Git & Workspace
        run: |
          echo "âš™ï¸ Configuring Git..."
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global init.defaultBranch main
          
          # Create workspace
          mkdir -p ~/Desktop/workspace
          
          echo "âœ… Git & workspace configured"

      - name: ğŸ“¥ Restore Projects from Backup
        run: |
          echo "ğŸ“¥ Checking for project backups..."
          
          TOKEN="${{ secrets.GH_TOKEN }}"
          [ -z "$TOKEN" ] && TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          BACKUP_URL="https://x-access-token:${TOKEN}@github.com/${GITHUB_ACTOR}/${{ env.BACKUP_REPO }}.git"
          
          if git ls-remote "$BACKUP_URL" &>/dev/null; then
            echo "ğŸ“‚ Restoring projects..."
            git clone --depth=1 "$BACKUP_URL" /tmp/backup-index
            
            if [ -f /tmp/backup-index/README.md ]; then
              RESTORE_COUNT=0
              while IFS= read -r REPO_PATH; do
                [ -z "$REPO_PATH" ] && continue
                REPO_NAME=$(basename "$REPO_PATH")
                echo "  ğŸ“¦ Restoring: $REPO_NAME"
                if git clone --depth=1 \
                  "https://x-access-token:${TOKEN}@github.com/${REPO_PATH}.git" \
                  "$HOME/Desktop/workspace/${REPO_NAME}" 2>/dev/null; then
                  RESTORE_COUNT=$((RESTORE_COUNT + 1))
                  echo "    âœ… Restored"
                else
                  echo "    âš ï¸ Failed"
                fi
              done < <(grep -oE '^\s*-\s*\S+' /tmp/backup-index/README.md | sed 's/^.*- *//')
              echo "âœ… Restored $RESTORE_COUNT projects"
            fi
            rm -rf /tmp/backup-index
          else
            echo "ğŸ“ No backup repository found"
          fi

      - name: ğŸ”„ Deploy Backup Watcher v3.0
        run: |
          echo "ğŸ”§ Deploying backup watcher v3.0..."
          
          TOKEN="${{ secrets.GH_TOKEN }}"
          [ -z "$TOKEN" ] && TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          # Create v3.0 backup watcher for macOS
          cat > ~/backup-watcher.sh << 'EOFWATCHER'
          #!/bin/bash
          
          # BACKUP WATCHER v3.0 - macOS Edition
          WATCH_DIR="$HOME/Desktop/workspace"
          GITHUB_USER="GITHUB_USER_PLACEHOLDER"
          TOKEN="TOKEN_PLACEHOLDER"
          BACKUP_REPO="backup-files"
          LOG_FILE="$HOME/backup-watcher.log"
          TRACKED_FILE="$HOME/.backed-up-projects"
          SYNC_INTERVAL=300
          
          touch "$TRACKED_FILE"
          
          log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }
          
          is_synced() { grep -qx "$1" "$TRACKED_FILE" 2>/dev/null; }
          mark_synced() { grep -qx "$1" "$TRACKED_FILE" 2>/dev/null || echo "$1" >> "$TRACKED_FILE"; }
          
          update_index() {
            local PROJECT_NAME="$1"
            (
              rm -rf /tmp/backup-idx-$$
              git clone --depth=1 "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$BACKUP_REPO.git" /tmp/backup-idx-$$ 2>/dev/null
              cd /tmp/backup-idx-$$ 2>/dev/null || return
              if ! grep -q "$GITHUB_USER/$PROJECT_NAME" README.md 2>/dev/null; then
                echo "- $GITHUB_USER/$PROJECT_NAME" >> README.md
                git add . && git commit -m "Add $PROJECT_NAME" && git push 2>/dev/null
                log "  âœ… Updated backup index"
              fi
              rm -rf /tmp/backup-idx-$$
            ) &
          }
          
          backup_or_sync() {
            local PROJECT_PATH="$1"
            local PROJECT_NAME=$(basename "$PROJECT_PATH")
            
            [ -z "$(ls -A "$PROJECT_PATH" 2>/dev/null)" ] && return
            cd "$PROJECT_PATH" || return
            
            if [ -d ".git" ]; then
              REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
              
              # External repo - fork it
              if echo "$REMOTE" | grep -q "github.com" && ! echo "$REMOTE" | grep -qi "$GITHUB_USER"; then
                log "ğŸ”„ External repo: $PROJECT_NAME - Forking..."
                curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" \
                  https://api.github.com/user/repos -d "{\"name\":\"$PROJECT_NAME\",\"private\":true}" >/dev/null 2>&1
                sleep 2
                git remote remove origin 2>/dev/null
                git remote add origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git"
                BRANCH=$(git branch --show-current 2>/dev/null || echo "main")
                if git push -u origin "$BRANCH" --force 2>/dev/null; then
                  log "âœ… Forked: $PROJECT_NAME"
                  mark_synced "$PROJECT_NAME"
                  update_index "$PROJECT_NAME"
                fi
                return
              fi
              
              # Our repo - sync changes
              if echo "$REMOTE" | grep -qi "$GITHUB_USER"; then
                git add -A 2>/dev/null
                if ! git diff --cached --quiet 2>/dev/null; then
                  git commit -m "Auto-sync: $(date '+%Y-%m-%d %H:%M')" 2>/dev/null
                  git push 2>/dev/null && log "ğŸ”„ Synced: $PROJECT_NAME"
                fi
                mark_synced "$PROJECT_NAME"
                return
              fi
            fi
            
            # New project
            is_synced "$PROJECT_NAME" && return
            log "ğŸ“¤ New project: $PROJECT_NAME"
            
            curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" \
              https://api.github.com/user/repos -d "{\"name\":\"$PROJECT_NAME\",\"private\":true}" >/dev/null 2>&1
            sleep 2
            
            [ ! -d ".git" ] && git init
            git add -A
            git commit -m "Initial commit - $(date '+%Y-%m-%d %H:%M')" 2>/dev/null
            git branch -M main
            git remote remove origin 2>/dev/null
            git remote add origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git"
            
            if git push -u origin main --force 2>/dev/null; then
              log "âœ… Backed up: $PROJECT_NAME"
              mark_synced "$PROJECT_NAME"
              update_index "$PROJECT_NAME"
            fi
          }
          
          log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          log "ğŸ‘ï¸  BACKUP WATCHER v3.0 STARTED (macOS)"
          log "   ğŸ“‚ Watching: $WATCH_DIR"
          log "   ğŸ”„ Sync Interval: ${SYNC_INTERVAL}s"
          log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Initial scan
          for dir in "$WATCH_DIR"/*/; do
            [ -d "$dir" ] && backup_or_sync "$dir"
          done
          
          # Continuous sync loop
          while true; do
            sleep $SYNC_INTERVAL
            log "ğŸ”„ Sync cycle..."
            for dir in "$WATCH_DIR"/*/; do
              [ -d "$dir" ] && backup_or_sync "$dir"
            done
          done
          EOFWATCHER
          
          sed -i '' "s|TOKEN_PLACEHOLDER|${TOKEN}|g" ~/backup-watcher.sh
          sed -i '' "s|GITHUB_USER_PLACEHOLDER|${GITHUB_ACTOR}|g" ~/backup-watcher.sh
          chmod +x ~/backup-watcher.sh
          
          # Start watcher
          nohup bash ~/backup-watcher.sh > /dev/null 2>&1 &
          
          echo "âœ… Backup Watcher v3.0 deployed (macOS)"
          echo "   âœ¨ Continuous sync every 5 min"
          echo "   âœ¨ External repo forking"

      - name: ğŸ’¡ Keep Alive & Connection Info
        run: |
          NGROK_URL=$(cat /tmp/ngrok_url.txt 2>/dev/null || echo "")
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                              â•‘"
          echo "â•‘    ğŸš€ macOS CLOUD WORKSTATION READY (SSH ACCESS) ğŸš€         â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ -n "$NGROK_URL" ]; then
            # Parse host and port from ngrok URL
            NGROK_HOST=$(echo "$NGROK_URL" | sed 's|tcp://||' | cut -d':' -f1)
            NGROK_PORT=$(echo "$NGROK_URL" | sed 's|tcp://||' | cut -d':' -f2)
            
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ğŸ” SSH CONNECTION                                              â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "  ssh -p $NGROK_PORT runner@$NGROK_HOST"
            echo ""
            if [ -n "${{ secrets.SSH_PASSWORD }}" ]; then
              echo "  Password: [Your SSH_PASSWORD secret]"
            else
              echo "  Password: P@ssw0rd123!"
            fi
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ğŸ’» REMOTE VS CODE (SSH Extension)                              â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "  1. Install 'Remote - SSH' extension in VS Code"
            echo "  2. Press F1 â†’ 'Remote-SSH: Connect to Host'"
            echo "  3. Enter: ssh://runner@$NGROK_HOST:$NGROK_PORT"
            echo ""
          else
            echo "âš ï¸ ngrok tunnel not ready - check 'Setup SSH Access' step"
          fi
          
          echo ""
          echo "ğŸ“Š Environment Details:"
          echo "  ğŸ OS:          macOS $(sw_vers -productVersion)"
          echo "  ğŸ’» Chip:        $(uname -m)"
          echo "  ğŸ‘¤ User:        runner"
          echo "  ğŸ“‚ Workspace:   ~/Desktop/workspace"
          echo "  â±ï¸  Duration:    6 hours"
          echo "  ğŸ”„ Backup:      v3.0 (Full sync + External repo forking)"
          echo ""
          echo "ğŸ’¡ Useful Commands:"
          echo "  cd ~/Desktop/workspace    # Go to workspace"
          echo "  code .                    # Open VS Code (via SSH)"
          echo "  brew install <package>    # Install packages"
          echo ""
          
          # Keep alive with heartbeat
          COUNTER=0
          while true; do
            sleep 1800
            COUNTER=$((COUNTER + 1))
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ’“ Heartbeat #$COUNTER"
            
            # Keep ngrok alive
            if ! pgrep -f "ngrok" > /dev/null; then
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ”„ Restarting ngrok..."
              ngrok tcp 22 --log=stdout > /tmp/ngrok.log 2>&1 &
              sleep 10
            fi
            
            # Keep watcher alive
            if ! pgrep -f "backup-watcher.sh" > /dev/null; then
              nohup bash ~/backup-watcher.sh > /dev/null 2>&1 &
            fi
          done
