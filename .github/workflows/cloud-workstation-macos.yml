name: â˜ï¸ Cloud Workstation - macOS (Final Fix)

on:
  workflow_dispatch:
    inputs:
      vnc_resolution:
        description: 'VNC Resolution'
        required: false
        default: '1920x1080'
        type: choice
        options:
          - '1920x1080'
          - '1280x720'
          - '2560x1440'

env:
  VNC_PORT: '5900'
  VNC_DISPLAY: ':99'
  VNC_GEOMETRY: ${{ github.event.inputs.vnc_resolution || '1920x1080' }}
  WORKSPACE_DIR: '$HOME/Desktop/workspace'
  BACKUP_REPO: 'backup-files'

jobs:
  macos-workstation:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: ðŸ“Š System Information
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ðŸŽ macOS Cloud Workstation Setup                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ–¥ï¸  macOS: $(sw_vers -productVersion)"
          echo "ðŸ’» Chip: $(uname -m)"
          echo "ðŸ“‚ User: $(whoami)"
          echo "ðŸ”§ Resolution: ${{ env.VNC_GEOMETRY }}"
          echo ""

      - name: ðŸ–¥ï¸ Install VNC Components
        run: |
          echo "ðŸ“¦ Installing VNC components..."
          brew install --cask xquartz
          brew install x11vnc
          brew install xterm
          echo "âœ… Components installed"

      - name: ðŸš€ Start Virtual Display & VNC Server
        run: |
          echo "ðŸš€ Starting virtual display and VNC server..."
          
          WIDTH=$(echo "${{ env.VNC_GEOMETRY }}" | cut -d'x' -f1)
          HEIGHT=$(echo "${{ env.VNC_GEOMETRY }}" | cut -d'x' -f2)
          
          # 1. Start Xvfb (Verified Working)
          /opt/X11/bin/Xvfb :99 -screen 0 ${WIDTH}x${HEIGHT}x24 -listen tcp &
          XVFB_PID=$!
          echo "Xvfb PID: $XVFB_PID"
          
          sleep 5
            
          # Verify Xvfb
          if ! ps -p $XVFB_PID > /dev/null; then
             echo "âŒ Xvfb failed to start"
             exit 1
          fi
          
          export DISPLAY=:99
          
          # 2. Start xterm (GUI Test)
          xterm -display :99 -geometry 120x40+10+10 -fs 14 -title "macOS Terminal" &
          
          sleep 2
            
          # 3. Start x11vnc (Minimal Mode)
          # -nopw: No password (avoids auth crashes)
          # -localhost: Bind to 127.0.0.1
          # -noxdamage -noxfixes -noxrecord: Disable extensions that cause crashes
          
          echo "Starting x11vnc on Port 5900..."
          
          x11vnc \
            -display :99 \
            -rfbport 5900 \
            -localhost \
            -nopw \
            -forever \
            -shared \
            -noxdamage \
            -noxfixes \
            -noxrecord \
            -bg \
            -o /tmp/x11vnc.log 2>&1
            
          sleep 5
            
          # 4. Verify VNC
          if pgrep x11vnc > /dev/null; then
            echo "âœ… x11vnc is RUNNING (PID: $(pgrep x11vnc))"
          else
            echo "âŒ x11vnc CRASHED!"
            cat /tmp/x11vnc.log
            exit 1
          fi
          
          # 5. Check Port
          echo "ðŸ” Checking Port 5900..."
          netstat -an | grep "\.5900 " | grep LISTEN || {
             echo "âŒ Port 5900 NOT listening!"
             exit 1
          }
          echo "âœ… Port 5900 listening"
          
          # Save PID
          pgrep x11vnc > /tmp/vnc_pid.txt

      - name: â˜ï¸ Setup Cloudflare Tunnel
        run: |
          echo "ðŸŒ Setting up Cloudflare tunnel..."
          brew install cloudflare/cloudflare/cloudflared
          
          # Tunnel to localhost:5900
          cloudflared tunnel --url tcp://localhost:5900 > /tmp/cloudflare.log 2>&1 &
          
          echo "â³ Waiting for tunnel..."
          sleep 15
          
          for i in {1..30}; do
            HOSTNAME=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cloudflare.log | head -1 | sed 's|https://||')
            if [ -n "$HOSTNAME" ]; then
              echo "$HOSTNAME" > /tmp/cf_host.txt
              echo "âœ… Tunnel: $HOSTNAME"
              break
            fi
            sleep 2
          done
          
          if [ -z "$(cat /tmp/cf_host.txt 2>/dev/null)" ]; then
            echo "âš ï¸ Tunnel initializing..."
            tail -20 /tmp/cloudflare.log
          fi

      - name: ðŸ Install Python & Node.js
        run: |
          echo "ðŸ“¦ Installing development tools..."
          brew install python@3.11 node wget curl jq
          python3 --version
          node --version

      - name: âš™ï¸ Configure Git & Workspace
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global init.defaultBranch main
          mkdir -p ~/Desktop/workspace

      - name: ðŸ“¥ Restore Projects from Backup
        run: |
          TOKEN="${{ secrets.GH_TOKEN }}"
          [ -z "$TOKEN" ] && TOKEN="${{ secrets.GITHUB_TOKEN }}"
          BACKUP_URL="https://x-access-token:${TOKEN}@github.com/${GITHUB_ACTOR}/${{ env.BACKUP_REPO }}.git"
          if git ls-remote "$BACKUP_URL" &>/dev/null; then
            git clone --depth=1 "$BACKUP_URL" /tmp/backup-index
            if [ -f /tmp/backup-index/README.md ]; then
              while IFS= read -r REPO_PATH; do
                [ -z "$REPO_PATH" ] && continue
                REPO_NAME=$(basename "$REPO_PATH")
                git clone --depth=1 "https://x-access-token:${TOKEN}@github.com/${REPO_PATH}.git" "$HOME/Desktop/workspace/${REPO_NAME}" 2>/dev/null
              done < <(grep -oE '^\s*-\s*\S+' /tmp/backup-index/README.md | sed 's/^.*- *//')
            fi
            rm -rf /tmp/backup-index
          fi

      - name: ðŸ”„ Deploy Backup Watcher v3.0
        run: |
          TOKEN="${{ secrets.GH_TOKEN }}"
          [ -z "$TOKEN" ] && TOKEN="${{ secrets.GITHUB_TOKEN }}"
          cat > ~/backup-watcher.sh << 'EOFWATCHER'
          #!/bin/bash
          WATCH_DIR="$HOME/Desktop/workspace"
          GITHUB_USER="GITHUB_USER_PLACEHOLDER"
          TOKEN="TOKEN_PLACEHOLDER"
          BACKUP_REPO="backup-files"
          LOG_FILE="$HOME/backup-watcher.log"
          TRACKED_FILE="$HOME/.backed-up-projects"
          SYNC_INTERVAL=300
          touch "$TRACKED_FILE"
          log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }
          is_synced() { grep -qx "$1" "$TRACKED_FILE" 2>/dev/null; }
          mark_synced() { grep -qx "$1" "$TRACKED_FILE" 2>/dev/null || echo "$1" >> "$TRACKED_FILE"; }
          backup_or_sync() {
            local PROJECT_PATH="$1"
            local PROJECT_NAME=$(basename "$PROJECT_PATH")
            [ -z "$(ls -A "$PROJECT_PATH" 2>/dev/null)" ] && return
            cd "$PROJECT_PATH" || return
            if [ -d ".git" ]; then
              REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
              if echo "$REMOTE" | grep -q "github.com" && ! echo "$REMOTE" | grep -qi "$GITHUB_USER"; then
                curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" https://api.github.com/user/repos -d "{\"name\":\"$PROJECT_NAME\",\"private\":true}" >/dev/null 2>&1
                git remote set-url origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git" 2>/dev/null || git remote add origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git"
                git push -u origin HEAD --force 2>/dev/null
                mark_synced "$PROJECT_NAME" && return
              fi
              if echo "$REMOTE" | grep -qi "$GITHUB_USER"; then
                git add -A 2>/dev/null && git diff --cached --quiet 2>/dev/null || (git commit -m "Auto-sync" 2>/dev/null && git push 2>/dev/null)
                mark_synced "$PROJECT_NAME" && return
              fi
            fi
            is_synced "$PROJECT_NAME" && return
            curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" https://api.github.com/user/repos -d "{\"name\":\"$PROJECT_NAME\",\"private\":true}" >/dev/null 2>&1
            [ ! -d ".git" ] && git init && git add -A && git commit -m "Initial commit" 2>/dev/null
            git branch -M main
            git remote set-url origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git" 2>/dev/null || git remote add origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git"
            git push -u origin main --force 2>/dev/null
            mark_synced "$PROJECT_NAME"
          }
          for dir in "$WATCH_DIR"/*/; do [ -d "$dir" ] && backup_or_sync "$dir"; done
          while true; do sleep $SYNC_INTERVAL; for dir in "$WATCH_DIR"/*/; do [ -d "$dir" ] && backup_or_sync "$dir"; done; done
          EOFWATCHER
          sed -i '' "s|TOKEN_PLACEHOLDER|${TOKEN}|g" ~/backup-watcher.sh
          sed -i '' "s|GITHUB_USER_PLACEHOLDER|${GITHUB_ACTOR}|g" ~/backup-watcher.sh
          chmod +x ~/backup-watcher.sh
          nohup bash ~/backup-watcher.sh > /dev/null 2>&1 &

      - name: ðŸ’¡ Keep Alive & Connection Info
        run: |
          CLOUDFLARE_HOST=$(cat /tmp/cf_host.txt 2>/dev/null || echo "")
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       ðŸŽ macOS CLOUD WORKSTATION READY (NO AUTH) ðŸŽ          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          if [ -n "$CLOUDFLARE_HOST" ]; then
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ðŸ“‹ STEP 1: Run on LOCAL machine                            â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "  cloudflared access tcp --hostname $CLOUDFLARE_HOST --url 127.0.0.1:5900"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ðŸ–¥ï¸  STEP 2: Connect VNC Viewer                              â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "  Server:   localhost:5900"
            echo "  Password: (None - Just press Enter)"
            echo "  ðŸ”’ Security: Tunnel verified"
            echo ""
          else
            echo "âš ï¸ Tunnel initializing..."
          fi
          echo "ðŸ“Š Environment: macOS $(sw_vers -productVersion) | Port 5900"
          
          while true; do
            sleep 1800
            echo "[$(date '+%H:%M:%S')] ðŸ’“"
            pgrep cloudflared > /dev/null || cloudflared tunnel --url tcp://localhost:5900 > /tmp/cloudflare.log 2>&1 &
          done
