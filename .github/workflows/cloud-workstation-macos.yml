name: ‚òÅÔ∏è Cloud Workstation - macOS

on:
  workflow_dispatch:
    inputs:
      vnc_resolution:
        description: 'VNC Resolution'
        required: false
        default: '1920x1080'
        type: choice
        options:
          - '1920x1080'
          - '1280x720'
          - '2560x1440'

env:
  VNC_PORT: '5902'
  VNC_DISPLAY: ':2'
  VNC_GEOMETRY: ${{ github.event.inputs.vnc_resolution || '1920x1080' }}
  WORKSPACE_DIR: '$HOME/Desktop/workspace'
  BACKUP_REPO: 'backup-files'

jobs:
  macos-workstation:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: üìä System Information
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë         üçé macOS Cloud Workstation Setup                     ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üñ•Ô∏è  macOS Version: $(sw_vers -productVersion)"
          echo "üíª Chip: $(uname -m)"
          echo "üìÇ User: $(whoami)"
          echo "üîß Resolution: ${{ env.VNC_GEOMETRY }}"
          echo ""

      - name: üñ•Ô∏è Install VNC Server (TigerVNC)
        run: |
          echo "üì¶ Installing TigerVNC..."
          
          # Install TigerVNC which includes vncserver
          brew install tiger-vnc
          
          # Also install required X11 components
          brew install --cask xquartz
          
          echo "‚úÖ TigerVNC installed"
          
          # Check what we have
          echo "üìã Installed VNC tools:"
          which vncserver || echo "vncserver not found"
          which Xvnc || echo "Xvnc not found"
          which vncviewer || echo "vncviewer not found"

      - name: üîê Configure VNC Password
        run: |
          echo "üîß Configuring VNC password..."
          
          VNC_PASS="${{ secrets.VNC_PASSWORD }}"
          [ -z "$VNC_PASS" ] && VNC_PASS="P@ssw0rd123!"
          
          mkdir -p ~/.vnc
          
          # Create VNC password file using vncpasswd
          echo "$VNC_PASS" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Create xstartup script
          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/bash
          # Simple X session for macOS VNC
          
          # Set background
          xsetroot -solid "#2E3440" 2>/dev/null || true
          
          # Start a simple terminal
          xterm -geometry 120x40+10+10 &
          
          # Keep session alive
          exec sleep infinity
          EOF
          
          chmod +x ~/.vnc/xstartup
          
          # Create workspace
          mkdir -p ~/Desktop/workspace
          
          echo "‚úÖ VNC configured"

      - name: üöÄ Start VNC Server
        run: |
          echo "üöÄ Starting VNC server..."
          
          # Export display
          export DISPLAY=${{ env.VNC_DISPLAY }}
          
          # Try to start Xvnc directly (TigerVNC's server)
          Xvnc ${{ env.VNC_DISPLAY }} \
            -geometry ${{ env.VNC_GEOMETRY }} \
            -depth 24 \
            -rfbport ${{ env.VNC_PORT }} \
            -SecurityTypes VncAuth \
            -PasswordFile ~/.vnc/passwd \
            -AlwaysShared \
            -AcceptKeyEvents \
            -AcceptPointerEvents \
            -SendCutText \
            -AcceptCutText &
          
          XVNC_PID=$!
          echo "Xvnc PID: $XVNC_PID"
          
          sleep 5
          
          # Verify VNC is running
          if ps -p $XVNC_PID > /dev/null 2>&1; then
            echo "‚úÖ Xvnc server running on display ${{ env.VNC_DISPLAY }} (port ${{ env.VNC_PORT }})"
            
            # Start xterm on the display
            export DISPLAY=${{ env.VNC_DISPLAY }}
            xterm -geometry 120x40+10+10 -title "macOS Cloud Terminal" &
            
            echo "üìä VNC Process:"
            ps aux | grep -E "(Xvnc|xterm)" | grep -v grep
          else
            echo "‚ö†Ô∏è Xvnc failed to start, checking logs..."
            
            # Try alternative: vncserver command if available
            echo "üîÑ Trying vncserver command..."
            vncserver ${{ env.VNC_DISPLAY }} \
              -geometry ${{ env.VNC_GEOMETRY }} \
              -depth 24 \
              -localhost no 2>&1 || {
              
              echo "‚ö†Ô∏è VNC server could not start"
              echo "üìã This is a known limitation of macOS GitHub runners"
              echo "üí° VNC may still work - check Cloudflare tunnel step"
            }
          fi
          
          # Save status
          pgrep -f "Xvnc|vncserver" > /tmp/vnc_pid.txt 2>/dev/null || true
        continue-on-error: true

      - name: ‚òÅÔ∏è Setup Cloudflare Tunnel
        run: |
          echo "üåê Setting up Cloudflare tunnel..."
          
          # Install cloudflared
          brew install cloudflare/cloudflare/cloudflared
          
          # Start tunnel on VNC port
          cloudflared tunnel --url tcp://localhost:${{ env.VNC_PORT }} > /tmp/cloudflare.log 2>&1 &
          CF_PID=$!
          echo $CF_PID > /tmp/cf_pid.txt
          
          echo "‚è≥ Waiting for Cloudflare tunnel..."
          sleep 15
          
          # Extract hostname
          TUNNEL_READY=false
          for i in {1..30}; do
            HOSTNAME=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cloudflare.log | head -1 | sed 's|https://||')
            if [ -n "$HOSTNAME" ]; then
              echo "$HOSTNAME" > /tmp/cf_host.txt
              echo "‚úÖ Cloudflare tunnel established"
              echo "üîó Hostname: $HOSTNAME"
              TUNNEL_READY=true
              break
            fi
            sleep 2
          done
          
          if [ "$TUNNEL_READY" = false ]; then
            echo "‚ö†Ô∏è Tunnel still initializing..."
            tail -20 /tmp/cloudflare.log
          fi

      - name: üêç Install Python
        run: |
          echo "üêç Installing Python..."
          brew install python@3.11
          python3 --version
          pip3 --version
          echo "‚úÖ Python installed"

      - name: üì¶ Install Node.js
        run: |
          echo "üì¶ Installing Node.js..."
          brew install node
          node --version
          npm --version
          echo "‚úÖ Node.js installed"

      - name: üíª Install Development Tools
        run: |
          echo "üíª Installing development tools..."
          brew install --cask visual-studio-code || echo "VS Code skipped"
          brew install wget curl jq git
          echo "‚úÖ Development tools installed"

      - name: ‚öôÔ∏è Configure Git & Workspace
        run: |
          echo "‚öôÔ∏è Configuring Git..."
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global init.defaultBranch main
          mkdir -p ~/Desktop/workspace
          echo "‚úÖ Git configured"

      - name: üì• Restore Projects from Backup
        run: |
          echo "üì• Checking for project backups..."
          
          TOKEN="${{ secrets.GH_TOKEN }}"
          [ -z "$TOKEN" ] && TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          BACKUP_URL="https://x-access-token:${TOKEN}@github.com/${GITHUB_ACTOR}/${{ env.BACKUP_REPO }}.git"
          
          if git ls-remote "$BACKUP_URL" &>/dev/null; then
            echo "üìÇ Restoring projects..."
            git clone --depth=1 "$BACKUP_URL" /tmp/backup-index
            
            if [ -f /tmp/backup-index/README.md ]; then
              RESTORE_COUNT=0
              while IFS= read -r REPO_PATH; do
                [ -z "$REPO_PATH" ] && continue
                REPO_NAME=$(basename "$REPO_PATH")
                echo "  üì¶ Restoring: $REPO_NAME"
                if git clone --depth=1 \
                  "https://x-access-token:${TOKEN}@github.com/${REPO_PATH}.git" \
                  "$HOME/Desktop/workspace/${REPO_NAME}" 2>/dev/null; then
                  RESTORE_COUNT=$((RESTORE_COUNT + 1))
                  echo "    ‚úÖ Restored"
                else
                  echo "    ‚ö†Ô∏è Failed"
                fi
              done < <(grep -oE '^\s*-\s*\S+' /tmp/backup-index/README.md | sed 's/^.*- *//')
              echo "‚úÖ Restored $RESTORE_COUNT project(s)"
            fi
            rm -rf /tmp/backup-index
          else
            echo "üìù No backup repository found"
          fi

      - name: üîÑ Deploy Backup Watcher v3.0
        run: |
          echo "üîß Deploying Backup Watcher v3.0..."
          
          TOKEN="${{ secrets.GH_TOKEN }}"
          [ -z "$TOKEN" ] && TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          cat > ~/backup-watcher.sh << 'EOFWATCHER'
          #!/bin/bash
          WATCH_DIR="$HOME/Desktop/workspace"
          GITHUB_USER="GITHUB_USER_PLACEHOLDER"
          TOKEN="TOKEN_PLACEHOLDER"
          BACKUP_REPO="backup-files"
          LOG_FILE="$HOME/backup-watcher.log"
          TRACKED_FILE="$HOME/.backed-up-projects"
          SYNC_INTERVAL=300
          
          touch "$TRACKED_FILE"
          log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }
          is_synced() { grep -qx "$1" "$TRACKED_FILE" 2>/dev/null; }
          mark_synced() { grep -qx "$1" "$TRACKED_FILE" 2>/dev/null || echo "$1" >> "$TRACKED_FILE"; }
          
          update_index() {
            local PROJECT_NAME="$1"
            (
              rm -rf /tmp/backup-idx-$$
              git clone --depth=1 "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$BACKUP_REPO.git" /tmp/backup-idx-$$ 2>/dev/null || return
              cd /tmp/backup-idx-$$ || return
              if ! grep -q "$GITHUB_USER/$PROJECT_NAME" README.md 2>/dev/null; then
                echo "- $GITHUB_USER/$PROJECT_NAME" >> README.md
                git add . && git commit -m "Add $PROJECT_NAME" 2>/dev/null && git push 2>/dev/null
              fi
              rm -rf /tmp/backup-idx-$$
            ) &
          }
          
          backup_or_sync() {
            local PROJECT_PATH="$1"
            local PROJECT_NAME=$(basename "$PROJECT_PATH")
            [ -z "$(ls -A "$PROJECT_PATH" 2>/dev/null)" ] && return
            cd "$PROJECT_PATH" || return
            
            if [ -d ".git" ]; then
              REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
              if echo "$REMOTE" | grep -q "github.com" && ! echo "$REMOTE" | grep -qi "$GITHUB_USER"; then
                log "üîÑ External repo: $PROJECT_NAME"
                curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" \
                  https://api.github.com/user/repos -d "{\"name\":\"$PROJECT_NAME\",\"private\":true}" >/dev/null 2>&1
                sleep 2
                git remote remove origin 2>/dev/null
                git remote add origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git"
                BRANCH=$(git branch --show-current 2>/dev/null || echo "main")
                git push -u origin "$BRANCH" --force 2>/dev/null && log "‚úÖ Forked: $PROJECT_NAME"
                mark_synced "$PROJECT_NAME"
                update_index "$PROJECT_NAME"
                return
              fi
              if echo "$REMOTE" | grep -qi "$GITHUB_USER"; then
                git add -A 2>/dev/null
                if ! git diff --cached --quiet 2>/dev/null; then
                  git commit -m "Auto-sync: $(date '+%Y-%m-%d %H:%M')" 2>/dev/null
                  git push 2>/dev/null && log "üîÑ Synced: $PROJECT_NAME"
                fi
                mark_synced "$PROJECT_NAME"
                return
              fi
            fi
            
            is_synced "$PROJECT_NAME" && return
            log "üì§ New project: $PROJECT_NAME"
            curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" \
              https://api.github.com/user/repos -d "{\"name\":\"$PROJECT_NAME\",\"private\":true}" >/dev/null 2>&1
            sleep 2
            [ ! -d ".git" ] && git init
            git add -A
            git commit -m "Initial commit - $(date '+%Y-%m-%d %H:%M')" 2>/dev/null
            git branch -M main
            git remote remove origin 2>/dev/null
            git remote add origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git"
            git push -u origin main --force 2>/dev/null && log "‚úÖ Backed up: $PROJECT_NAME"
            mark_synced "$PROJECT_NAME"
            update_index "$PROJECT_NAME"
          }
          
          log "üëÅÔ∏è BACKUP WATCHER v3.0 (macOS) STARTED"
          for dir in "$WATCH_DIR"/*/; do [ -d "$dir" ] && backup_or_sync "$dir"; done
          while true; do
            sleep $SYNC_INTERVAL
            log "üîÑ Sync cycle..."
            for dir in "$WATCH_DIR"/*/; do [ -d "$dir" ] && backup_or_sync "$dir"; done
          done
          EOFWATCHER
          
          sed -i '' "s|TOKEN_PLACEHOLDER|${TOKEN}|g" ~/backup-watcher.sh
          sed -i '' "s|GITHUB_USER_PLACEHOLDER|${GITHUB_ACTOR}|g" ~/backup-watcher.sh
          chmod +x ~/backup-watcher.sh
          nohup bash ~/backup-watcher.sh > /dev/null 2>&1 &
          echo "‚úÖ Backup Watcher v3.0 deployed"

      - name: üí° Keep Alive & Connection Info
        run: |
          CLOUDFLARE_HOST=$(cat /tmp/cf_host.txt 2>/dev/null || echo "")
          VNC_RUNNING=$(pgrep -f "Xvnc" > /dev/null && echo "yes" || echo "no")
          
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë                                                              ‚ïë"
          echo "‚ïë    üçé macOS CLOUD WORKSTATION READY  üçé                      ‚ïë"
          echo "‚ïë                                                              ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          
          if [ -n "$CLOUDFLARE_HOST" ]; then
            echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
            echo "‚îÇ üìã STEP 1: Run on your LOCAL machine                           ‚îÇ"
            echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
            echo ""
            echo "  cloudflared access tcp --hostname $CLOUDFLARE_HOST --url 127.0.0.1:${{ env.VNC_PORT }}"
            echo ""
            echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
            echo "‚îÇ üñ•Ô∏è  STEP 2: Connect with VNC Viewer                             ‚îÇ"
            echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
            echo ""
            echo "  Server:   localhost:${{ env.VNC_PORT }}"
            if [ -n "${{ secrets.VNC_PASSWORD }}" ]; then
              echo "  Password: [Your VNC_PASSWORD secret]"
            else
              echo "  Password: P@ssw0rd123!"
            fi
            echo ""
            if [ "$VNC_RUNNING" = "yes" ]; then
              echo "  ‚úÖ VNC Server Status: RUNNING"
            else
              echo "  ‚ö†Ô∏è VNC Server Status: May have issues (macOS limitation)"
              echo "     Try connecting anyway - it might work!"
            fi
          else
            echo "‚ö†Ô∏è Cloudflare tunnel still initializing..."
          fi
          
          echo ""
          echo "üìä Environment:"
          echo "  üçé OS:          macOS $(sw_vers -productVersion)"
          echo "  üíª Chip:        $(uname -m)"
          echo "  üìÇ Workspace:   ~/Desktop/workspace"
          echo "  ‚è±Ô∏è  Duration:    6 hours"
          echo "  üîÑ Backup:      v3.0 Full Sync"
          echo ""
          
          # Keep alive
          while true; do
            sleep 1800
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] üíì Heartbeat"
            
            # Keep cloudflare alive
            if ! pgrep -f "cloudflared" > /dev/null; then
              cloudflared tunnel --url tcp://localhost:${{ env.VNC_PORT }} > /tmp/cloudflare.log 2>&1 &
              sleep 10
            fi
            
            # Keep watcher alive
            if ! pgrep -f "backup-watcher.sh" > /dev/null; then
              nohup bash ~/backup-watcher.sh > /dev/null 2>&1 &
            fi
          done
