name: â˜ï¸ Cloud Workstation - macOS

on:
  workflow_dispatch:
    inputs:
      vnc_resolution:
        description: 'VNC Resolution'
        required: false
        default: '1920x1080'
        type: choice
        options:
          - '1920x1080'
          - '1280x720'
          - '2560x1440'

env:
  VNC_PORT: '5902'
  VNC_DISPLAY: ':99'
  VNC_GEOMETRY: ${{ github.event.inputs.vnc_resolution || '1920x1080' }}
  WORKSPACE_DIR: '$HOME/Desktop/workspace'
  BACKUP_REPO: 'backup-files'

jobs:
  macos-workstation:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: ðŸ“Š System Information
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ðŸŽ macOS Cloud Workstation Setup                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ–¥ï¸  macOS: $(sw_vers -productVersion)"
          echo "ðŸ’» Chip: $(uname -m)"
          echo "ðŸ“‚ User: $(whoami)"
          echo "ðŸ”§ Resolution: ${{ env.VNC_GEOMETRY }}"
          echo ""

      - name: ðŸ–¥ï¸ Install VNC Server
        run: |
          echo "ðŸ“¦ Installing VNC components..."
          
          # Install XQuartz for X11 support
          brew install --cask xquartz
          
          # Install x11vnc
          brew install x11vnc
          
          # Check installed binaries
          echo "ðŸ“‹ Installed:"
          ls -la /opt/X11/bin/Xvfb 2>/dev/null && echo "âœ… Xvfb found" || echo "âš ï¸ Xvfb missing"
          which x11vnc && echo "âœ… x11vnc found" || echo "âš ï¸ x11vnc missing"
          
          echo "âœ… VNC components installed"

      - name: ðŸ” Configure VNC Password
        run: |
          echo "ðŸ”§ Configuring VNC password..."
          
          VNC_PASS="${{ secrets.VNC_PASSWORD }}"
          [ -z "$VNC_PASS" ] && VNC_PASS="mypassword"
          
          mkdir -p ~/.vnc
          
          # Create password file for x11vnc
          x11vnc -storepasswd "$VNC_PASS" ~/.vnc/passwd
          
          # Create workspace
          mkdir -p ~/Desktop/workspace
          
          echo "âœ… VNC password configured"

      - name: ðŸš€ Start Virtual Display & VNC Server
        run: |
          echo "ðŸš€ Starting virtual display and VNC server..."
          
          WIDTH=$(echo "${{ env.VNC_GEOMETRY }}" | cut -d'x' -f1)
          HEIGHT=$(echo "${{ env.VNC_GEOMETRY }}" | cut -d'x' -f2)
          
          # Start Xvfb (X Virtual Framebuffer)
          # Explicitly listen on TCP to allow local connections
          /opt/X11/bin/Xvfb ${{ env.VNC_DISPLAY }} -screen 0 ${WIDTH}x${HEIGHT}x24 -listen tcp &
          XVFB_PID=$!
          echo "Xvfb PID: $XVFB_PID"
          echo $XVFB_PID > /tmp/xvfb_pid.txt
          
          sleep 5
          
          # Check if Xvfb is running
          if ps -p $XVFB_PID > /dev/null 2>&1; then
            echo "âœ… Xvfb running"
            export DISPLAY=${{ env.VNC_DISPLAY }}
            
            # Set a background color
            xsetroot -solid "#2E3440" 2>/dev/null || true
            
            # Start xterm
            xterm -display ${{ env.VNC_DISPLAY }} -geometry 120x40+10+10 -fa 'Monospace' -fs 12 -title "macOS Terminal" &
            
            sleep 2
            
            # Start x11vnc
            # -listen 127.0.0.1 forces IPv4 localhost binding (avoids bad handshake)
            echo "Starting x11vnc on 127.0.0.1:${{ env.VNC_PORT }}..."
            
            x11vnc \
              -display ${{ env.VNC_DISPLAY }} \
              -rfbport ${{ env.VNC_PORT }} \
              -listen 127.0.0.1 \
              -rfbauth ~/.vnc/passwd \
              -forever \
              -shared \
              -bg \
              -o /tmp/x11vnc.log 2>&1 || {
              
              echo "âš ï¸ x11vnc failed, checking log..."
              cat /tmp/x11vnc.log 2>/dev/null || true
            }
            
            sleep 5
            
            # Check VNC status and ports
            if pgrep x11vnc > /dev/null; then
              echo "âœ… x11vnc running"
              pgrep -a x11vnc
              
              # Check if port is open
              echo "Checking port ${{ env.VNC_PORT }}..."
              netstat -an | grep "${{ env.VNC_PORT }}" || echo "âš ï¸ Port ${{ env.VNC_PORT }} not found in netstat"
            else
              echo "âš ï¸ x11vnc exited immediately - check log:"
              cat /tmp/x11vnc.log 2>/dev/null | tail -20
            fi
          else
            echo "âŒ Xvfb failed to start"
            exit 1
          fi
          
          # Save status for later
          pgrep x11vnc > /tmp/vnc_pid.txt 2>/dev/null || echo "0" > /tmp/vnc_pid.txt

      - name: â˜ï¸ Setup Cloudflare Tunnel
        run: |
          echo "ðŸŒ Setting up Cloudflare tunnel..."
          
          brew install cloudflare/cloudflare/cloudflared
          
          # Explicitly tunnel to 127.0.0.1 (IPv4)
          cloudflared tunnel --url tcp://127.0.0.1:${{ env.VNC_PORT }} > /tmp/cloudflare.log 2>&1 &
          CF_PID=$!
          echo $CF_PID > /tmp/cf_pid.txt
          
          echo "â³ Waiting for tunnel..."
          sleep 15
          
          for i in {1..30}; do
            HOSTNAME=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cloudflare.log | head -1 | sed 's|https://||')
            if [ -n "$HOSTNAME" ]; then
              echo "$HOSTNAME" > /tmp/cf_host.txt
              echo "âœ… Tunnel: $HOSTNAME"
              break
            fi
            sleep 2
          done
          
          if [ -z "$(cat /tmp/cf_host.txt 2>/dev/null)" ]; then
            echo "âš ï¸ Tunnel initializing..."
            tail -10 /tmp/cloudflare.log
          fi

      - name: ðŸ Install Python & Node.js
        run: |
          echo "ðŸ“¦ Installing development tools..."
          brew install python@3.11 node wget curl jq
          python3 --version
          node --version
          echo "âœ… Dev tools installed"

      - name: âš™ï¸ Configure Git & Workspace
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global init.defaultBranch main
          mkdir -p ~/Desktop/workspace
          echo "âœ… Git configured"

      - name: ðŸ“¥ Restore Projects from Backup
        run: |
          echo "ðŸ“¥ Checking backups..."
          
          TOKEN="${{ secrets.GH_TOKEN }}"
          [ -z "$TOKEN" ] && TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          BACKUP_URL="https://x-access-token:${TOKEN}@github.com/${GITHUB_ACTOR}/${{ env.BACKUP_REPO }}.git"
          
          if git ls-remote "$BACKUP_URL" &>/dev/null; then
            echo "ðŸ“‚ Restoring projects..."
            git clone --depth=1 "$BACKUP_URL" /tmp/backup-index
            
            if [ -f /tmp/backup-index/README.md ]; then
              RESTORE_COUNT=0
              while IFS= read -r REPO_PATH; do
                [ -z "$REPO_PATH" ] && continue
                REPO_NAME=$(basename "$REPO_PATH")
                echo "  ðŸ“¦ $REPO_NAME"
                if git clone --depth=1 \
                  "https://x-access-token:${TOKEN}@github.com/${REPO_PATH}.git" \
                  "$HOME/Desktop/workspace/${REPO_NAME}" 2>/dev/null; then
                  RESTORE_COUNT=$((RESTORE_COUNT + 1))
                fi
              done < <(grep -oE '^\s*-\s*\S+' /tmp/backup-index/README.md | sed 's/^.*- *//')
              echo "âœ… Restored $RESTORE_COUNT project(s)"
            fi
            rm -rf /tmp/backup-index
          fi

      - name: ðŸ”„ Deploy Backup Watcher v3.0
        run: |
          TOKEN="${{ secrets.GH_TOKEN }}"
          [ -z "$TOKEN" ] && TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          cat > ~/backup-watcher.sh << 'EOFWATCHER'
          #!/bin/bash
          WATCH_DIR="$HOME/Desktop/workspace"
          GITHUB_USER="GITHUB_USER_PLACEHOLDER"
          TOKEN="TOKEN_PLACEHOLDER"
          BACKUP_REPO="backup-files"
          LOG_FILE="$HOME/backup-watcher.log"
          TRACKED_FILE="$HOME/.backed-up-projects"
          SYNC_INTERVAL=300
          
          touch "$TRACKED_FILE"
          log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }
          is_synced() { grep -qx "$1" "$TRACKED_FILE" 2>/dev/null; }
          mark_synced() { grep -qx "$1" "$TRACKED_FILE" 2>/dev/null || echo "$1" >> "$TRACKED_FILE"; }
          
          backup_or_sync() {
            local PROJECT_PATH="$1"
            local PROJECT_NAME=$(basename "$PROJECT_PATH")
            [ -z "$(ls -A "$PROJECT_PATH" 2>/dev/null)" ] && return
            cd "$PROJECT_PATH" || return
            
            if [ -d ".git" ]; then
              REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
              if echo "$REMOTE" | grep -q "github.com" && ! echo "$REMOTE" | grep -qi "$GITHUB_USER"; then
                log "ðŸ”„ Forking: $PROJECT_NAME"
                curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" \
                  https://api.github.com/user/repos -d "{\"name\":\"$PROJECT_NAME\",\"private\":true}" >/dev/null 2>&1
                sleep 2
                git remote set-url origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git" 2>/dev/null || \
                  git remote add origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git"
                git push -u origin HEAD --force 2>/dev/null && log "âœ… Forked: $PROJECT_NAME"
                mark_synced "$PROJECT_NAME"
                return
              fi
              if echo "$REMOTE" | grep -qi "$GITHUB_USER"; then
                git add -A 2>/dev/null
                if ! git diff --cached --quiet 2>/dev/null; then
                  git commit -m "Auto-sync $(date '+%Y-%m-%d %H:%M')" 2>/dev/null
                  git push 2>/dev/null && log "ðŸ”„ Synced: $PROJECT_NAME"
                fi
                mark_synced "$PROJECT_NAME"
                return
              fi
            fi
            
            is_synced "$PROJECT_NAME" && return
            log "ðŸ“¤ New: $PROJECT_NAME"
            curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" \
              https://api.github.com/user/repos -d "{\"name\":\"$PROJECT_NAME\",\"private\":true}" >/dev/null 2>&1
            sleep 2
            [ ! -d ".git" ] && git init
            git add -A && git commit -m "Initial commit" 2>/dev/null
            git branch -M main
            git remote set-url origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git" 2>/dev/null || \
              git remote add origin "https://x-access-token:$TOKEN@github.com/$GITHUB_USER/$PROJECT_NAME.git"
            git push -u origin main --force 2>/dev/null && log "âœ… Backed up: $PROJECT_NAME"
            mark_synced "$PROJECT_NAME"
          }
          
          log "ðŸ‘ï¸ BACKUP WATCHER v3.0 (macOS)"
          for dir in "$WATCH_DIR"/*/; do [ -d "$dir" ] && backup_or_sync "$dir"; done
          while true; do
            sleep $SYNC_INTERVAL
            for dir in "$WATCH_DIR"/*/; do [ -d "$dir" ] && backup_or_sync "$dir"; done
          done
          EOFWATCHER
          
          sed -i '' "s|TOKEN_PLACEHOLDER|${TOKEN}|g" ~/backup-watcher.sh
          sed -i '' "s|GITHUB_USER_PLACEHOLDER|${GITHUB_ACTOR}|g" ~/backup-watcher.sh
          chmod +x ~/backup-watcher.sh
          nohup bash ~/backup-watcher.sh > /dev/null 2>&1 &
          echo "âœ… Backup Watcher v3.0"

      - name: ðŸ’¡ Keep Alive & Connection Info
        run: |
          CLOUDFLARE_HOST=$(cat /tmp/cf_host.txt 2>/dev/null || echo "")
          VNC_PID=$(cat /tmp/vnc_pid.txt 2>/dev/null || echo "0")
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       ðŸŽ macOS CLOUD WORKSTATION READY ðŸŽ                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ -n "$CLOUDFLARE_HOST" ]; then
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ðŸ“‹ STEP 1: Run on LOCAL machine                            â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "  cloudflared access tcp --hostname $CLOUDFLARE_HOST --url 127.0.0.1:${{ env.VNC_PORT }}"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ðŸ–¥ï¸  STEP 2: Connect VNC Viewer                              â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "  Server:   localhost:${{ env.VNC_PORT }}"
            if [ -n "${{ secrets.VNC_PASSWORD }}" ]; then
              echo "  Password: [VNC_PASSWORD secret]"
            else
              echo "  Password: mypassword"
            fi
            echo ""
            
            if [ "$VNC_PID" != "0" ] && [ -n "$VNC_PID" ]; then
              echo "  âœ… VNC Status: RUNNING (PID: $VNC_PID)"
            else
              echo "  âš ï¸ VNC Status: Check 'Start VNC Server' step logs"
            fi
          else
            echo "âš ï¸ Tunnel initializing - check logs above"
          fi
          
          echo ""
          echo "ðŸ“Š Environment:"
          echo "  ðŸŽ macOS $(sw_vers -productVersion) | $(uname -m)"
          echo "  ðŸ“‚ ~/Desktop/workspace"
          echo "  â±ï¸  6 hours | ðŸ”„ Backup v3.0"
          echo ""
          
          while true; do
            sleep 1800
            echo "[$(date '+%H:%M:%S')] ðŸ’“"
            pgrep cloudflared > /dev/null || cloudflared tunnel --url tcp://127.0.0.1:${{ env.VNC_PORT }} > /tmp/cloudflare.log 2>&1 &
            pgrep backup-watcher > /dev/null || nohup bash ~/backup-watcher.sh > /dev/null 2>&1 &
          done
